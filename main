#include <DHT.h>

// Pin Definitions
#define TRIG_PIN 9
#define ECHO_PIN 10
#define IR_PIN A0
#define LDR_PIN A1
#define DHT_PIN 2
#define RED_LED 5
#define YELLOW_LED 6
#define GREEN_LED 7

// DHT Sensor Setup
#define DHT_TYPE DHT11
DHT dht(DHT_PIN, DHT_TYPE);

// Thresholds
#define SEVERE_FLOOD 25
#define MODERATE_FLOOD 50
#define IR_CLOSE 150
#define LDR_DARK 400
#define TEMP_TH 32.0
#define HUM_TH 70.0

void setup() {
  Serial.begin(9600);
  dht.begin();
  
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(IR_PIN, INPUT);
  pinMode(LDR_PIN, INPUT);
  pinMode(RED_LED, OUTPUT);
  pinMode(YELLOW_LED, OUTPUT);
  pinMode(GREEN_LED, OUTPUT);
  
  digitalWrite(RED_LED, LOW);
  digitalWrite(YELLOW_LED, LOW);
  digitalWrite(GREEN_LED, LOW);
  
  Serial.println(F("\n=== FLOOD RESCUE SYSTEM ===\n"));
  delay(2000);
}

void loop() {
  Serial.println(F("\n--- NEW SCAN ---"));
  
  // Read Ultrasonic
  long duration = getUltrasonicDuration();
  if (duration == 0) duration = 1;
  float distanceCM = (duration * 0.034) / 2;
  
  // Read other sensors
  int irRaw = analogRead(IR_PIN);
  int ldrRaw = analogRead(LDR_PIN);
  float tempC = dht.readTemperature();
  float humP = dht.readHumidity();
  
  if (isnan(tempC)) tempC = 0.0;
  if (isnan(humP)) humP = 0.0;
  
  bool humanNear = (irRaw > 0 && irRaw < IR_CLOSE);
  bool dark = (ldrRaw > 0 && ldrRaw < LDR_DARK);
  bool validReading = (distanceCM > 0 && distanceCM <= 400);
  
  // Water Level Analysis
  Serial.println(F("\n** WATER LEVEL **"));
  
  if (!validReading) {
    digitalWrite(RED_LED, LOW);
    digitalWrite(YELLOW_LED, HIGH);
    digitalWrite(GREEN_LED, LOW);
    Serial.println(F("Sensor Error - Caution Mode"));
    Serial.println(F("Vehicle: BOAT"));
  }
  else if (distanceCM < SEVERE_FLOOD) {
    digitalWrite(RED_LED, HIGH);
    digitalWrite(YELLOW_LED, LOW);
    digitalWrite(GREEN_LED, LOW);
    Serial.print(F("Water at: "));
    Serial.print(distanceCM);
    Serial.println(F(" cm"));
    Serial.println(F("Level: SEVERE FLOOD"));
    Serial.println(F("Vehicle: HELICOPTER"));
  }
  else if (distanceCM <= MODERATE_FLOOD) {
    digitalWrite(RED_LED, LOW);
    digitalWrite(YELLOW_LED, HIGH);
    digitalWrite(GREEN_LED, LOW);
    Serial.print(F("Water at: "));
    Serial.print(distanceCM);
    Serial.println(F(" cm"));
    Serial.println(F("Level: MODERATE FLOOD"));
    Serial.println(F("Vehicle: BOAT"));
  }
  else {
    digitalWrite(RED_LED, LOW);
    digitalWrite(YELLOW_LED, LOW);
    digitalWrite(GREEN_LED, HIGH);
    Serial.print(F("Water at: "));
    Serial.print(distanceCM);
    Serial.println(F(" cm"));
    Serial.println(F("Level: LOW FLOOD - SAFE"));
    Serial.println(F("Vehicle: TRUCK"));
  }
  
  // Human Presence
  Serial.println(F("\n** HUMAN DETECTION **"));
  Serial.print(F("IR Sensor: "));
  Serial.print(irRaw);
  if (humanNear) {
    Serial.println(F(" - HUMAN NEARBY"));
  } else {
    Serial.println(F(" - No close object"));
  }
  
  Serial.print(F("Temperature: "));
  Serial.print(tempC);
  Serial.print(F(" C"));
  if (tempC > TEMP_TH) {
    Serial.println(F(" - Body heat!"));
  } else {
    Serial.println(F(" - Normal"));
  }
  
  Serial.print(F("Humidity: "));
  Serial.print(humP);
  Serial.print(F(" %"));
  if (humP > HUM_TH) {
    Serial.println(F(" - Elevated!"));
  } else {
    Serial.println(F(" - Normal"));
  }
  
  // Lighting
  Serial.println(F("\n** LIGHTING **"));
  Serial.print(F("LDR: "));
  Serial.print(ldrRaw);
  if (dark) {
    Serial.println(F(" - DARK AREA"));
    Serial.println(F("Lighting: NO - Flashlight needed!"));
  } else {
    Serial.println(F(" - BRIGHT"));
    Serial.println(F("Lighting: YES - Good visibility"));
  }
  
  // Mission Decision
  bool survivor = (humanNear && dark && tempC > TEMP_TH && humP > HUM_TH);
  
  Serial.println(F("\n** MISSION **"));
  if (survivor) {
    Serial.println(F(">>> HUMAN CONFIRMED <<<"));
    Serial.println(F("Type: RESCUE OPERATION"));
    Serial.println(F("Action: Immediate evacuation!"));
  } else {
    Serial.println(F("No survivor detected"));
    Serial.println(F("Type: SEARCH & MONITOR"));
  }
  
  Serial.println(F("\n--- End Scan ---\n"));
  delay(3000);
}

long getUltrasonicDuration() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  return pulseIn(ECHO_PIN, HIGH, 30000);
}
